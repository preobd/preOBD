; PlatformIO Project Configuration File
; Build configurations for different hardware platforms

[platformio]
default_envs = teensy41

; ============================================================================
; SHARED CONFIGURATIONS
; ============================================================================

; Common settings for all environments
[env]
framework = arduino
monitor_speed = 115200
monitor_echo = no
monitor_raw = yes
lib_extra_dirs = lib
; Exclude sensor subdirectories from individual compilation
; They are included via sensor_read.cpp
build_src_filter = +<*> -<inputs/sensors/>
; Version injection script (injects FW_BUILD_NUMBER and FW_GIT_HASH)
extra_scripts = pre:scripts/version_inject.py

; ============================================================================
; LIBRARY DEPENDENCY GROUPS
; ============================================================================

; Display libraries
[display_libs]
lib_deps =
    marcoschwartz/LiquidCrystal_I2C@^1.1.4

; CAN libraries (MCP2515 via SPI - supports multiple instances)
[can_libs]
lib_deps =
    autowp/autowp-mcp2515@^1.0.3

; Sensor libraries
[sensor_libs]
lib_deps =
    adafruit/Adafruit BME280 Library@^2.2.2

; EEPROM/JSON configuration (not needed for static builds)
[eeprom_libs]
lib_deps =
    bblanchon/ArduinoJson@^7.2.1

; CLI library (embedded-cli for command-line interface)
[cli_libs]
lib_deps =
    https://github.com/funbiscuit/embedded-cli.git

; ============================================================================
; FEATURE FLAG SETS
; ============================================================================

; Standard feature set (all outputs enabled)
[standard_features]
build_flags =
    -D ENABLE_CAN
    -D ENABLE_REALDASH
    -D ENABLE_SERIAL_OUTPUT
    -D ENABLE_SD_LOGGING
    -D ENABLE_LCD
    -D ENABLE_ALARMS
    -D ENABLE_LED
    -D ENABLE_TEST_MODE
    -D ENABLE_BME280
    -D ENABLE_RELAY_OUTPUT
    -D MAX_RELAYS=2

; Minimal feature set for memory-constrained boards
[minimal_features]
build_flags =
    -D ENABLE_LCD
    -D ENABLE_SERIAL_OUTPUT
    -D ENABLE_ALARMS

; Production feature set (no debug messages)
[production_features]
build_flags =
    ${standard_features.build_flags}
    -D DISABLE_DEBUG_MESSAGES

; ============================================================================
; TEENSY 4.1 (RECOMMENDED PLATFORM)
; ============================================================================

[env:teensy41]
platform = teensy
board = teensy41
upload_protocol = teensy-cli
build_flags =
    -D TEENSY_41
    -D USE_FLEXCAN_NATIVE
    -D SD_CS_PIN=254                    ; Built-in SD card
    ${standard_features.build_flags}
    -O2
    -Wall
lib_deps =
    ${display_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    https://github.com/tonton81/FlexCAN_T4.git
    https://github.com/tonton81/WDT_T4.git

; ============================================================================
; TEENSY 4.0
; ============================================================================

[env:teensy40]
platform = teensy
board = teensy40
upload_protocol = teensy-cli
build_flags =
    -D TEENSY_40
    -D USE_FLEXCAN_NATIVE
    ${standard_features.build_flags}
    -O2
    -Wall
lib_deps =
    ${display_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    https://github.com/tonton81/FlexCAN_T4.git
    https://github.com/tonton81/WDT_T4.git

; ============================================================================
; TEENSY 3.6
; ============================================================================

[env:teensy36]
platform = teensy
board = teensy36
build_flags =
    -D TEENSY_36
    -D USE_FLEXCAN_NATIVE
    ${standard_features.build_flags}
    -O2
    -Wall
lib_deps =
    ${display_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    https://github.com/tonton81/FlexCAN_T4.git

; ============================================================================
; ESP32-S3 (BLE Only - No Bluetooth Classic)
; ============================================================================

[env:esp32s3dev]
platform = espressif32
board = esp32-s3-devkitc-1
build_flags =
    -D ESP32
    -D CONFIG_IDF_TARGET_ESP32S3       ; Explicitly set for chip detection
    ${standard_features.build_flags}
    -O2
    -Wall
lib_deps =
    ${display_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    https://github.com/handmade0octopus/ESP32-TWAI-CAN.git
    avinabmalla/ESP32_BleSerial@^1.0.4

; ============================================================================
; ARDUINO MEGA 2560
; ============================================================================

[env:mega2560]
platform = atmelavr
board = megaatmega2560
build_flags =
    -D ARDUINO_MEGA
    ${standard_features.build_flags}
    -O2
    -Wall
lib_deps =
    ${display_libs.lib_deps}
    ${can_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    SD

; ============================================================================
; ARDUINO UNO (Static Config Only - Memory Constrained)
; ============================================================================

[env:uno_static]
platform = atmelavr
board = uno
build_flags =
    -D ARDUINO_UNO
    -D USE_STATIC_CONFIG               ; Static build (no EEPROM/JSON)
    -D DISABLE_DEBUG_MESSAGES          ; Save flash/RAM on constrained platform
    ${minimal_features.build_flags}
    -O2
    -Wall
    -Wno-stringop-overflow             ; Suppress false positive on strncpy
lib_deps =
    ${display_libs.lib_deps}
    ; Note: ArduinoJson excluded - not needed for static builds
    ; Note: BME280 excluded - not enabled in minimal_features
    ; Note: CAN/SD excluded - insufficient flash space

; ============================================================================
; DEBUG ENVIRONMENT
; ============================================================================

[env:debug]
platform = teensy
board = teensy41
build_flags =
    -D TEENSY_41
    -D USE_FLEXCAN_NATIVE
    -D SD_CS_PIN=254
    -D DEBUG
    ${standard_features.build_flags}
    -Og
    -g
    -Wall
    -Wextra
build_type = debug
lib_deps =
    ${display_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    https://github.com/tonton81/FlexCAN_T4.git
    https://github.com/tonton81/WDT_T4.git
; Note: monitor_raw=yes inherited from [env], so monitor_filters removed to avoid conflict

; ============================================================================
; HYBRID CONTROLLER ENVIRONMENTS
; ============================================================================
; These environments enable mixing different CAN controller types on different buses
; Example: ESP32 TWAI (native, bus 0) + MCP2515 (SPI, bus 1) for dual-bus operation

[env:esp32s3_hybrid]
platform = espressif32
board = esp32-s3-devkitm-1
framework = arduino
build_flags =
    -D ESP32_S3
    ${standard_features.build_flags}
    -D ENABLE_CAN_HYBRID
    -D CAN_BUS_0_TYPE=CanControllerType::TWAI
    -D CAN_BUS_1_TYPE=CanControllerType::MCP2515
    -O2
    -Wall
lib_deps =
    ${display_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    https://github.com/handmade0octopus/ESP32-TWAI-CAN.git
    autowp/autowp-mcp2515@^1.0.3

[env:teensy41_hybrid]
platform = teensy
board = teensy41
framework = arduino
build_flags =
    -D TEENSY_41
    -D USE_FLEXCAN_NATIVE
    -D SD_CS_PIN=254
    ${standard_features.build_flags}
    -D ENABLE_CAN_HYBRID
    -D CAN_BUS_0_TYPE=CanControllerType::FLEXCAN
    -D CAN_BUS_1_TYPE=CanControllerType::FLEXCAN
    -D CAN_BUS_2_TYPE=CanControllerType::FLEXCAN
    -D CAN_BUS_3_TYPE=CanControllerType::MCP2515
    -O2
    -Wall
lib_deps =
    ${display_libs.lib_deps}
    ${sensor_libs.lib_deps}
    ${eeprom_libs.lib_deps}
    ${cli_libs.lib_deps}
    https://github.com/tonton81/FlexCAN_T4.git
    autowp/autowp-mcp2515@^1.0.3