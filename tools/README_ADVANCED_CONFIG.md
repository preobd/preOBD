# Advanced Configuration Guide

The openEMS configuration tool now supports custom calibrations through the `advanced_config.h` file. This feature allows you to define custom sensor calibrations that override the default presets.

## Features

### Custom Calibration Types

The tool supports four types of custom calibrations:

1. **Thermistor (Steinhart-Hart)** - For thermistor-based temperature sensors
   - Parameters: `bias_resistor`, `steinhart_a`, `steinhart_b`, `steinhart_c`

2. **Pressure (Linear)** - For linear voltage-based pressure sensors
   - Parameters: `voltage_min`, `voltage_max`, `pressure_min`, `pressure_max`

3. **Pressure (Polynomial/VDO)** - For VDO-style polynomial pressure sensors
   - Parameters: `bias_resistor`, `poly_a`, `poly_b`, `poly_c`

4. **RPM** - For RPM sensors (alternator, hall effect, etc.)
   - Parameters: `poles`, `pulley_ratio`, `calibration_mult`, `timeout_ms`, `min_rpm`, `max_rpm`

## Using the Configuration Tool

### Interactive Mode

When adding or editing a sensor input, you'll be prompted:

```
Custom calibration for Input 0?
Add custom calibration? [y/N]:
```

If you choose `y`, you'll be guided through selecting and configuring a custom calibration:

```
Calibration type for VDO_120C_STEINHART: CAL_THERMISTOR_STEINHART
Available calibration types:
  1. Thermistor (Steinhart-Hart)
  2. Pressure (Linear)
  3. Pressure (Polynomial/VDO)
  4. RPM
Select calibration type [1-4]: 1

Bias resistor (Ohms) [1000.0]: 1000.0
Steinhart A coefficient [1.129e-3]: 0.001129
Steinhart B coefficient [2.341e-4]: 0.0002341
Steinhart C coefficient [8.775e-8]: 8.775e-08
```

### Example: Adding a Custom Thermistor

```bash
python3 tools/configure.py
```

Follow the prompts:
1. Add an input with pin and sensor selection
2. When asked "Add custom calibration?", enter `y`
3. Select calibration type `1` (Thermistor Steinhart-Hart)
4. Enter your custom calibration values

### Example: Loading and Editing Configuration

```bash
python3 tools/configure.py --load tools/saved-configs/my_config.json
```

This loads an existing configuration. You can then:
- Edit existing inputs (including their calibrations)
- Add new inputs with custom calibrations
- Delete inputs

## JSON Configuration Format

Custom calibrations are stored in the JSON configuration file:

```json
{
  "metadata": {
    "tool_version": "1.0.0",
    "platform": "uno"
  },
  "inputs": [
    {
      "input_number": 0,
      "pin": "A0",
      "application": "COOLANT_TEMP",
      "application_index": 1,
      "sensor": "VDO_120C_STEINHART",
      "sensor_index": 1,
      "custom_calibration": {
        "type": 1,
        "calibration_name": "ThermistorSteinhartCalibration",
        "bias_resistor": 1000.0,
        "steinhart_a": 0.001129,
        "steinhart_b": 0.0002341,
        "steinhart_c": 8.775e-08
      }
    }
  ]
}
```

## Generated Files

### config.h

The tool updates the static configuration block in `src/config.h`:

```c
#ifdef USE_STATIC_CONFIG

// ============================================================================
// STATIC SENSOR CONFIGURATION
// Generated by openEMS-config v1.0.0 on 2025-12-18 19:45:36
// Platform: uno
// DO NOT EDIT MANUALLY - Use tools/configure.py to regenerate
// ============================================================================

#define NUM_CONFIGURED_INPUTS 1

// ----- Input 0: COOLANT_TEMP -----
#define INPUT_0_PIN           A0
#define INPUT_0_APPLICATION   1            // COOLANT_TEMP
#define INPUT_0_SENSOR        1            // VDO_120C_STEINHART

#endif // USE_STATIC_CONFIG
```

### advanced_config.h

Custom calibrations are written to `src/advanced_config.h`:

```c
// ============================================================================
// CUSTOM CALIBRATIONS
// Generated by openEMS-config v1.0.0 on 2025-12-18 19:45:36
// DO NOT EDIT MANUALLY - Use tools/configure.py to regenerate
// ============================================================================

// ----- Input 0: COOLANT_TEMP Custom Calibration -----
#define INPUT_0_CUSTOM_CALIBRATION
#ifdef INPUT_0_CUSTOM_CALIBRATION
    static const PROGMEM ThermistorSteinhartCalibration input_0_custom_cal = {
        .bias_resistor = 1000.0,
        .steinhart_a = 0.001129,
        .steinhart_b = 0.0002341,
        .steinhart_c = 8.775e-08
    };
#endif
```

## Backup Files

The tool automatically creates backup files:
- `src/config.h.bak` - Backup of config.h before modification
- `src/advanced_config.h.bak` - Backup of advanced_config.h before modification

## Command-Line Options

```bash
# Create new configuration
python3 tools/configure.py

# Load and edit existing configuration
python3 tools/configure.py --load tools/saved-configs/my_config.json

# Specify project directory
python3 tools/configure.py --project-dir /path/to/project

# Specify target platform (overrides auto-detection)
python3 tools/configure.py --platform uno

# Generate thin libraries (reduces flash usage)
python3 tools/configure.py --generate-thin-libs
```

## Calibration Examples

### Example 1: Custom Thermistor (Steinhart-Hart) for Coolant Temperature

```json
"custom_calibration": {
  "type": 1,
  "calibration_name": "ThermistorSteinhartCalibration",
  "bias_resistor": 470.0,
  "steinhart_a": 1.299e-3,
  "steinhart_b": 2.401e-4,
  "steinhart_c": 1.301e-7
}
```

### Example 2: Custom Thermistor (Beta Equation) for Oil Temperature

```json
"custom_calibration": {
  "type": 3,
  "calibration_name": "BetaCalibration",
  "bias_resistor": 10000.0,
  "beta": 3950.0,
  "r0": 10000.0,
  "t0": 25.0
}
```

**Note:** Beta equation is simpler than Steinhart-Hart when you know the Beta coefficient (often provided in thermistor datasheets). Provides good accuracy (±2°C) with only 4 parameters instead of Steinhart-Hart's complex coefficients.

### Example 3: Custom Linear Pressure Sensor

```json
"custom_calibration": {
  "type": 2,
  "calibration_name": "LinearCalibration",
  "voltage_min": 0.5,
  "voltage_max": 4.5,
  "pressure_min": 0.0,
  "pressure_max": 3.0
}
```

### Example 4: Custom VDO Polynomial Pressure Sensor

```json
"custom_calibration": {
  "type": 4,
  "calibration_name": "PolynomialCalibration",
  "bias_resistor": 1000.0,
  "poly_a": -0.3682,
  "poly_b": 36.465,
  "poly_c": 10.648
}
```

### Example 5: Custom RPM Calibration

```json
"custom_calibration": {
  "type": 5,
  "calibration_name": "RPMCalibration",
  "poles": 18,
  "pulley_ratio": 3.0,
  "calibration_mult": 1.0,
  "timeout_ms": 2000,
  "min_rpm": 300,
  "max_rpm": 8000
}
```

## Tips

1. **Start with defaults**: The tool provides sensible default values for each calibration type
2. **Test incrementally**: Add one custom calibration at a time and test
3. **Keep backups**: The tool creates `.bak` files and saves JSON configs to `tools/saved-configs/`
4. **Use version control**: Commit your `tools/saved-configs/*.json` files to track changes
5. **Document your sensors**: Use descriptive names and note the sensor part numbers

## Troubleshooting

### "Failed to update config.h"
- Ensure `USE_STATIC_CONFIG` is defined in config.h
- Check file permissions

### "Failed to update advanced_config.h"
- Ensure the file exists at `src/advanced_config.h`
- Check the file has the required markers

### Calibration not working
- Verify the custom calibration is enabled (`#define INPUT_N_CUSTOM_CALIBRATION`)
- Check that the calibration struct name matches: `input_N_custom_cal`
- Ensure you're using `USE_STATIC_CONFIG` mode

## Related Files

- `tools/configure.py` - Main configuration tool
- `tools/openems_config/config_generator.py` - Code generation functions
- `src/config.h` - Main configuration file
- `src/advanced_config.h` - Advanced calibration file
- `src/lib/sensor_types.h` - Calibration structure definitions
